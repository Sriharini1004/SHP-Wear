#include <WiFi.h>
#include "DHTesp.h"
#include "ThingSpeak.h"

/* -------- PIN DEFINITIONS -------- */
#define DHT_PIN     14
#define POT_LM35    22
#define POT_SWEAT   2
#define POT_UV      17
#define LED_PIN     5

/* -------- WIFI & THINGSPEAK -------- */
const char* WIFI_NAME = "Wokwi-GUEST";
const char* WIFI_PASSWORD = "";
unsigned long myChannelNumber = 3215885;
const char* myApiKey = "2GAV6YHV63P9HW24";

/* -------- OBJECTS -------- */
DHTesp dht;
WiFiClient client;

/* -------- GLOBAL VARIABLES -------- */
float ambTemp, humidity, bodyTemp;
int sweat, uv;

void setup() {
  Serial.begin(115200);

  pinMode(LED_PIN, OUTPUT);
  pinMode(POT_LM35, INPUT);
  pinMode(POT_SWEAT, INPUT);
  pinMode(POT_UV, INPUT);

  dht.setup(DHT_PIN, DHTesp::DHT22);

  WiFi.begin(WIFI_NAME, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }
  Serial.println("WiFi Connected");

  ThingSpeak.begin(client);
}

/* -------- MAP FUNCTION -------- */
float mapFloat(int x, int in_min, int in_max, float out_min, float out_max) {
  return (float)(x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}

/* -------- ALERT -------- */
void alertLED() {
  digitalWrite(LED_PIN, HIGH);
  delay(300);
  digitalWrite(LED_PIN, LOW);
}

void loop() {

  /* -------- DHT22 READ -------- */
  TempAndHumidity data = dht.getTempAndHumidity();
  ambTemp = data.temperature;
  humidity = data.humidity;

  /* -------- POTENTIOMETER READ -------- */
  bodyTemp = mapFloat(analogRead(POT_LM35), 0, 4095, 35.0, 42.0);
  sweat = analogRead(POT_SWEAT);
  uv = analogRead(POT_UV);

  /* -------- CONDITIONS -------- */
  bool hotBody   = bodyTemp > 38.0;
  bool highTemp  = ambTemp > 35.0;
  bool highSweat = sweat > 2000;
  bool highUV    = uv > 2000;

  /* -------- THINGSPEAK -------- */
  ThingSpeak.setField(1, ambTemp);
  ThingSpeak.setField(2, humidity);
  ThingSpeak.setField(3, bodyTemp);
  ThingSpeak.setField(4, sweat);
  ThingSpeak.setField(5, uv);

  ThingSpeak.writeFields(myChannelNumber, myApiKey);

  /* -------- SERIAL OUTPUT -------- */
  Serial.println("Ambient Temp: " + String(ambTemp) + " °C");
  Serial.println("Humidity: " + String(humidity) + " %");
  Serial.println("Body Temp: " + String(bodyTemp) + " °C");
  Serial.println("Sweat: " + String(sweat));
  Serial.println("UV: " + String(uv));

  if (hotBody || highTemp || (highSweat && highUV)) {
    alertLED();
    Serial.println("⚠️ Heat Stress Risk Detected!");
  }

  Serial.println("-----------------------------");
  delay(15000);   // ThingSpeak minimum delay
}
